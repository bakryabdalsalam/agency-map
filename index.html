<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Egypt Real Estate Map - Complex Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />
  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  />
  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
  />


  <style>
    /* -------------------- RESET & GLOBAL -------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #faf9f5; /* Light sand background */
      color: #333;
      overflow-x: hidden;
      transition: all 0.3s ease-in-out;
    }
    body[dir="rtl"] {
      direction: rtl;
    }

    /* -------------------- HEADER -------------------- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #004b7c;
      color: #fff;
      padding: 0.5rem 1rem;
    }
    .logo img {
      max-height: 50px;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 1rem;
    }
    nav ul li a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    nav ul li a:hover {
      color: #ffdd00; /* A golden accent color on hover */
    }
    .language-toggle button {
      background: transparent;
      border: 1px solid #fff;
      color: #fff;
      margin-left: 0.5rem;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .language-toggle button.active {
      background: #fff;
      color: #004b7c;
    }

    /* -------------------- MAIN LAYOUT -------------------- */
    main {
      display: flex;
      min-height: calc(100vh - 80px);
      transition: all 0.3s ease;
    }

    /* ----- FILTER PANEL (Sidebar on desktop) ----- */
    #filter-panel {
      width: 300px;
      background-color: #fff;
      border-right: 1px solid #ccc;
      padding: 1rem;
      transition: transform 0.3s ease;
    }
    #filter-panel h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: #004b7c;
    }
    #filter-panel label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    #filter-panel input[type="text"],
    #filter-panel input[type="range"],
    #filter-panel select {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #filter-panel button {
      margin-top: 1.5rem;
      width: 100%;
      background-color: #004b7c;
      color: #fff;
      border: none;
      padding: 0.7rem;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }
    #filter-panel button:hover {
      background-color: #00375f;
    }

    /* ----- MAP CONTAINER ----- */
    #map-container {
      flex: 1;
      position: relative;
      z-index: 1;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 600px; /* Adjust as needed */
    }

    /* ----- FILTER TOGGLE (Mobile) ----- */
    #mobile-filter-toggle {
      display: none; /* Only show on mobile */
      background-color: #004b7c;
      color: #fff;
      border: none;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      margin: 0.5rem;
      border-radius: 4px;
    }
    #mobile-filter-toggle:hover {
      background-color: #00375f;
    }

    /* ----- COLLAPSED FILTER PANEL (Mobile) ----- */
    .collapsed {
      transform: translateX(-100%);
    }

    /* -------------------- MODAL (PROPERTY DETAILS) -------------------- */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      position: relative;
      background: #fff;
      margin: 5% auto;
      padding: 1rem;
      width: 80%;
      max-width: 900px;
      border-radius: 8px;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.4rem;
      cursor: pointer;
      font-weight: bold;
    }
    .modal-images {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .modal-images img {
      max-width: 200px;
      border-radius: 4px;
    }
    .modal-content h2 {
      margin-bottom: 0.5rem;
      color: #004b7c;
    }

    /* -------------------- FAVORITES & COMPARE BAR -------------------- */
    #favorites-compare-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #004b7c;
      color: #fff;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }
    #favorites-compare-bar .section {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    #favorites-compare-bar button {
      background: #ffdd00;
      color: #004b7c;
      border: none;
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 600;
    }
    #favorites-compare-bar .fav-list,
    #favorites-compare-bar .comp-list {
      font-size: 0.9rem;
      cursor: pointer;
      transition: text-decoration 0.2s;
    }
    #favorites-compare-bar .fav-list:hover,
    #favorites-compare-bar .comp-list:hover {
      text-decoration: underline;
    }

    /* -------------------- FOOTER -------------------- */
    footer {
      background-color: #eee;
      padding: 1rem;
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
    }
    footer .footer-info,
    footer .social-links,
    footer .subscribe-form {
      margin: 0.5rem;
    }
    footer a {
      color: #004b7c;
      text-decoration: none;
      margin: 0 0.3rem;
      font-weight: 500;
    }
    footer a:hover {
      text-decoration: underline;
    }
    footer .subscribe-form input[type="email"] {
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    footer .subscribe-form button {
      padding: 0.5rem 1rem;
      background: #004b7c;
      color: #fff;
      border: none;
      border-radius: 4px;
      margin-left: 0.3rem;
      cursor: pointer;
      font-weight: 600;
    }

    /* -------------------- RESPONSIVE -------------------- */
    @media (max-width: 992px) {
      #filter-panel {
        width: 250px;
      }
    }
    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
      #map-container {
        min-height: 400px;
        height: 400px;
      }
      #mobile-filter-toggle {
        display: block; /* Show the toggle button */
      }
      /* Initially hide the sidebar (collapsed), toggled by JS */
      #filter-panel {
        position: absolute;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 1100;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <img src="https://via.placeholder.com/120x50?text=Agency+Logo" alt="Agency Logo">
    </div>
    <nav>
      <ul>
        <li><a href="#" data-lang="homeLink">Home</a></li>
        <li><a href="#" data-lang="propLink">Properties</a></li>
        <li><a href="#" data-lang="contactLink">Contact</a></li>
      </ul>
    </nav>
    <div class="language-toggle">
      <button id="btn-en" class="active">EN</button>
      <button id="btn-ar">AR</button>
    </div>
  </header>

  <!-- FAVORITES & COMPARE BAR (pinned at bottom) -->
  <div id="favorites-compare-bar">
    <div class="section">
      <span data-lang="favoriteList">Favorites:</span>
      <span class="fav-list" id="fav-list-count">0</span>
      <span data-lang="compareList">Compare:</span>
      <span class="comp-list" id="comp-list-count">0</span>
    </div>
    <div class="section">
      <button id="btn-view-compare" data-lang="compareBtn">View Comparison</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <main>
    <!-- FILTER TOGGLE (mobile) -->
    <button id="mobile-filter-toggle" data-lang="filterToggle">Show Filters</button>

    <!-- FILTER PANEL -->
    <section id="filter-panel">
      <h2 data-lang="filterTitle">Filter Properties</h2>

      <label for="search-input" data-lang="searchLabel">Search by keyword:</label>
      <input type="text" id="search-input" placeholder="Enter city or neighborhood" />

      <label for="property-type" data-lang="typeLabel">Property Type:</label>
      <select id="property-type">
        <option value="all" selected data-lang="typeAll">All Types</option>
        <option value="apartment" data-lang="typeApartment">Apartment</option>
        <option value="villa" data-lang="typeVilla">Villa</option>
        <option value="commercial" data-lang="typeCommercial">Commercial</option>
      </select>

      <label for="price-range" data-lang="priceLabel">Max Price (EGP):</label>
      <input type="range" id="price-range" min="0" max="10000000" step="50000" value="10000000" />

      <label for="bedrooms" data-lang="bedroomLabel">Bedrooms:</label>
      <select id="bedrooms">
        <option value="any" data-lang="any">Any</option>
        <option value="1">1+</option>
        <option value="2">2+</option>
        <option value="3">3+</option>
        <option value="4">4+</option>
      </select>

      <label for="bathrooms" data-lang="bathroomLabel">Bathrooms:</label>
      <select id="bathrooms">
        <option value="any" data-lang="any">Any</option>
        <option value="1">1+</option>
        <option value="2">2+</option>
        <option value="3">3+</option>
      </select>

      <button id="btn-filter" data-lang="filterBtn">Apply Filters</button>

      <hr style="margin:1.5rem 0;" />

      <button id="btn-locate" style="background-color: #ffa500;" data-lang="locateBtn">Locate Me</button>
      <button id="btn-explore" style="background-color: #bada55;" data-lang="exploreBtn">Explore Hotspots</button>
    </section>

    <!-- MAP CONTAINER -->
    <section id="map-container">
      <div id="map"></div>
    </section>

    <!-- PROPERTY DETAILS MODAL -->
    <div id="property-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div id="modal-body"><!-- Populated via JS --></div>
      </div>
    </div>

    <!-- COMPARISON MODAL -->
    <div id="compare-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn compare-close">&times;</span>
        <div id="compare-body"><!-- Populated via JS --></div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-info">
      <p data-lang="footerContact">Contact: +20 123 456 789</p>
      <p>Email: info@realestate-eg.com</p>
    </div>
    <div class="social-links">
      <a href="#" target="_blank">Facebook</a>
      <a href="#" target="_blank">Instagram</a>
      <a href="#" target="_blank">LinkedIn</a>
    </div>
    <div class="subscribe-form">
      <label for="subscribe-email" data-lang="subscribeLabel">Subscribe for updates:</label>
      <input type="email" id="subscribe-email" placeholder="Email address" />
      <button data-lang="subscribeBtn">Subscribe</button>
    </div>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <script>
    // -------------------- BILINGUAL TRANSLATIONS --------------------
    const translations = {
      en: {
        homeLink: "Home",
        propLink: "Properties",
        contactLink: "Contact",

        filterToggle: "Show Filters",
        filterTitle: "Filter Properties",
        searchLabel: "Search by keyword:",
        typeLabel: "Property Type:",
        typeAll: "All Types",
        typeApartment: "Apartment",
        typeVilla: "Villa",
        typeCommercial: "Commercial",
        priceLabel: "Max Price (EGP):",
        bedroomLabel: "Bedrooms:",
        bathroomLabel: "Bathrooms:",
        any: "Any",
        filterBtn: "Apply Filters",
        locateBtn: "Locate Me",
        exploreBtn: "Explore Hotspots",

        footerContact: "Contact: +20 123 456 789",
        subscribeLabel: "Subscribe for updates:",
        subscribeBtn: "Subscribe",

        favoriteList: "Favorites:",
        compareList: "Compare:",
        compareBtn: "View Comparison",

        propPrice: "Price",
        propType: "Type",
        propBeds: "Bedrooms",
        propBaths: "Bathrooms",

        modalMoreInfo: "Request More Info",
        addedToFav: "Added to Favorites",
        removedFromFav: "Removed from Favorites",
        addedToCompare: "Added to Comparison",
        removedFromCompare: "Removed from Comparison",
        contactSuccess: "Inquiry sent! We'll contact you soon."
      },
      ar: {
        homeLink: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
        propLink: "ÿßŸÑÿπŸÇÿßÿ±ÿßÿ™",
        contactLink: "ÿßÿ™ÿµŸÑ ÿ®ŸÜÿß",

        filterToggle: "ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÅŸÑÿßÿ™ÿ±",
        filterTitle: "ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿπŸÇÿßÿ±ÿßÿ™",
        searchLabel: "ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©:",
        typeLabel: "ŸÜŸàÿπ ÿßŸÑÿπŸÇÿßÿ±:",
        typeAll: "ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜŸàÿßÿπ",
        typeApartment: "ÿ¥ŸÇÿ©",
        typeVilla: "ŸÅŸäŸÑÿß",
        typeCommercial: "ÿ™ÿ¨ÿßÿ±Ÿä",
        priceLabel: "ÿ£ŸÇÿµŸâ ÿ≥ÿπÿ± (ÿ¨.ŸÖ):",
        bedroomLabel: "ÿπÿØÿØ ÿßŸÑÿ∫ÿ±ŸÅ:",
        bathroomLabel: "ÿπÿØÿØ ÿßŸÑÿ≠ŸÖÿßŸÖÿßÿ™:",
        any: "ÿ£Ÿä",
        filterBtn: "ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿßÿ™ÿ±",
        locateBtn: "ŸÖŸàŸÇÿπŸä",
        exploreBtn: "ÿßÿ≥ÿ™ŸÉÿ¥ŸÅ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ",

        footerContact: "ÿßÿ™ÿµÿßŸÑ: +20 123 456 789",
        subscribeLabel: "ÿßÿ¥ÿ™ÿ±ŸÉ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™:",
        subscribeBtn: "ÿßÿ¥ÿ™ÿ±ŸÉ",

        favoriteList: "ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©:",
        compareList: "ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ©:",
        compareBtn: "ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ©",

        propPrice: "ÿßŸÑÿ≥ÿπÿ±",
        propType: "ÿßŸÑŸÜŸàÿπ",
        propBeds: "ÿ∫ÿ±ŸÅ ÿßŸÑŸÜŸàŸÖ",
        propBaths: "ÿßŸÑÿ≠ŸÖÿßŸÖÿßÿ™",

        modalMoreInfo: "ÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™",
        addedToFav: "ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖŸÅÿ∂ŸÑÿ©",
        removedFromFav: "ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©",
        addedToCompare: "ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿ©",
        removedFromCompare: "ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ©",
        contactSuccess: "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ±! ÿ≥ŸÜÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÇÿ±Ÿäÿ®Ÿãÿß."
      }
    };

    let currentLang = localStorage.getItem("siteLang") || "en";

    const btnEn = document.getElementById("btn-en");
    const btnAr = document.getElementById("btn-ar");

    function updateLanguage(lang) {
      currentLang = lang;
      localStorage.setItem("siteLang", lang);

      // Update active button styles
      if (lang === "en") {
        btnEn.classList.add("active");
        btnAr.classList.remove("active");
        document.body.dir = "ltr";
      } else {
        btnAr.classList.add("active");
        btnEn.classList.remove("active");
        document.body.dir = "rtl";
      }

      // Translate elements
      document.querySelectorAll("[data-lang]").forEach(el => {
        const key = el.getAttribute("data-lang");
        if (translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });
    }
    // Initialize language
    updateLanguage(currentLang);

    // Event listeners
    btnEn.addEventListener("click", () => updateLanguage("en"));
    btnAr.addEventListener("click", () => updateLanguage("ar"));

    // -------------------- MAP INITIALIZATION --------------------
    const map = L.map("map").setView([30.0444, 31.2357], 6); // Center on Egypt

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    // -------------------- SAMPLE PROPERTY DATA (INLINE) --------------------
    const allProperties = [
      {
        "id": 1,
        "title": "Modern Apartment in Cairo",
        "type": "apartment",
        "price": 500000,
        "bedrooms": 2,
        "bathrooms": 2,
        "location": {
          "city": "Cairo",
          "neighborhood": "Maadi",
          "lat": 29.964722,
          "lng": 31.276944
        },
        "images": [
          "https://via.placeholder.com/400x300?text=Apartment+1A",
          "https://via.placeholder.com/400x300?text=Apartment+1B"
        ]
      },
      {
        "id": 2,
        "title": "Spacious Villa in Sheikh Zayed",
        "type": "villa",
        "price": 2000000,
        "bedrooms": 4,
        "bathrooms": 3,
        "location": {
          "city": "Giza",
          "neighborhood": "Sheikh Zayed",
          "lat": 30.0238,
          "lng": 30.9754
        },
        "images": [
          "https://via.placeholder.com/400x300?text=Villa+2A",
          "https://via.placeholder.com/400x300?text=Villa+2B"
        ]
      },
      {
        "id": 3,
        "title": "Commercial Office in Zamalek",
        "type": "commercial",
        "price": 750000,
        "bedrooms": 0,
        "bathrooms": 1,
        "location": {
          "city": "Cairo",
          "neighborhood": "Zamalek",
          "lat": 30.0626,
          "lng": 31.2212
        },
        "images": [
          "https://via.placeholder.com/400x300?text=Office+3A"
        ]
      },
      {
        "id": 4,
        "title": "Apartment in Alexandria",
        "type": "apartment",
        "price": 300000,
        "bedrooms": 2,
        "bathrooms": 1,
        "location": {
          "city": "Alexandria",
          "neighborhood": "Gleem",
          "lat": 31.2387,
          "lng": 29.9489
        },
        "images": [
          "https://via.placeholder.com/400x300?text=Apt+Alex+4A"
        ]
      },
      {
        "id": 5,
        "title": "Beachfront Villa in Hurghada",
        "type": "villa",
        "price": 3500000,
        "bedrooms": 5,
        "bathrooms": 4,
        "location": {
          "city": "Hurghada",
          "neighborhood": "El Gouna",
          "lat": 27.3949,
          "lng": 33.8483
        },
        "images": [
          "https://via.placeholder.com/400x300?text=Hurghada+Villa+5A"
        ]
      },
      {
        "id": 6,
        "title": "Office Space in New Cairo",
        "type": "commercial",
        "price": 600000,
        "bedrooms": 0,
        "bathrooms": 2,
        "location": {
          "city": "New Cairo",
          "neighborhood": "5th Settlement",
          "lat": 30.0300,
          "lng": 31.4913
        },
        "images": [
          "https://via.placeholder.com/400x300?text=Office+NewCairo+6A"
        ]
      }
    ];

    // -------------------- MARKER CLUSTER SETUP --------------------
    const markersCluster = L.markerClusterGroup();
    map.addLayer(markersCluster);

    // We store references to each marker so we can manage them upon filtering
    let allMarkers = [];

    // Create markers (initial load)
    createMarkers(allProperties);

    function createMarkers(properties) {
      markersCluster.clearLayers(); // Clear cluster group
      allMarkers = []; // Reset array

      properties.forEach((prop) => {
        const marker = L.marker([prop.location.lat, prop.location.lng]);

        // Create a minimal popup (with a "View Details" button)
        const popupHtml = `
          <div style="min-width:150px">
            <strong>${prop.title}</strong><br>
            <span>${translations[currentLang].propPrice}: ${prop.price} EGP</span><br>
            <button onclick="showPropertyDetails(${prop.id})" style="margin-top:5px;">
              ${translations[currentLang].modalMoreInfo}
            </button>
            <br><br>
            <!-- Favorites & Compare Buttons -->
            <button onclick="toggleFavorite(${prop.id})">‚ù§Ô∏è</button>
            <button onclick="toggleCompare(${prop.id})">üîç</button>
          </div>
        `;

        marker.bindPopup(popupHtml);
        markersCluster.addLayer(marker);
        allMarkers.push(marker);
      });
    }

    // -------------------- FILTER LOGIC --------------------
    const filterBtn = document.getElementById("btn-filter");
    filterBtn.addEventListener("click", applyFilters);

    function applyFilters() {
      const keyword = document.getElementById("search-input").value.toLowerCase();
      const type = document.getElementById("property-type").value;
      const maxPrice = parseInt(document.getElementById("price-range").value, 10) || 10000000;
      const bedrooms = document.getElementById("bedrooms").value;
      const bathrooms = document.getElementById("bathrooms").value;

      const filtered = allProperties.filter((prop) => {
        const matchesKeyword =
          prop.title.toLowerCase().includes(keyword) ||
          prop.location.city.toLowerCase().includes(keyword) ||
          prop.location.neighborhood.toLowerCase().includes(keyword);

        const matchesType = (type === "all") ? true : (prop.type === type);
        const matchesPrice = prop.price <= maxPrice;
        const matchesBedrooms = (bedrooms === "any") ? true : (prop.bedrooms >= parseInt(bedrooms));
        const matchesBathrooms = (bathrooms === "any") ? true : (prop.bathrooms >= parseInt(bathrooms));

        return matchesKeyword && matchesType && matchesPrice && matchesBedrooms && matchesBathrooms;
      });

      createMarkers(filtered);
    }

    // -------------------- PROPERTY DETAILS MODAL --------------------
    const modal = document.getElementById("property-modal");
    const closeBtn = modal.querySelector(".close-btn");
    const modalBody = document.getElementById("modal-body");

    function showPropertyDetails(id) {
      const property = allProperties.find((p) => p.id === id);
      if (!property) return;

      // Build modal content
      let imagesHtml = "";
      if (property.images && property.images.length) {
        imagesHtml = property.images
          .map((img) => `<img src="${img}" alt="Prop Image" />`)
          .join("");
      }

      modalBody.innerHTML = `
        <h2>${property.title}</h2>
        <p><strong>${translations[currentLang].propPrice}:</strong> ${property.price} EGP</p>
        <p><strong>${translations[currentLang].propType}:</strong> ${property.type}</p>
        <p><strong>${translations[currentLang].propBeds}:</strong> ${property.bedrooms}</p>
        <p><strong>${translations[currentLang].propBaths}:</strong> ${property.bathrooms}</p>
        <div class="modal-images">${imagesHtml}</div>
        <button onclick="contactProperty(${property.id})" style="margin-top:1rem;">
          ${translations[currentLang].modalMoreInfo}
        </button>
      `;

      // Show modal
      modal.style.display = "block";
    }

    // Make function accessible from HTML popups
    window.showPropertyDetails = showPropertyDetails;

    // Close modal
    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });
    window.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.style.display = "none";
      }
    });

    // -------------------- CONTACT ACTION --------------------
    function contactProperty(id) {
      alert(translations[currentLang].contactSuccess);
      // In a real app, you'd open a form or send request to server
    }
    window.contactProperty = contactProperty;

    // -------------------- FAVORITES & COMPARISON (LOCALSTORAGE) --------------------
    let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
    let compareList = JSON.parse(localStorage.getItem("compareList")) || [];

    const favListCount = document.getElementById("fav-list-count");
    const compListCount = document.getElementById("comp-list-count");

    function updateCounts() {
      favListCount.textContent = favorites.length;
      compListCount.textContent = compareList.length;
    }
    updateCounts();

    function toggleFavorite(id) {
      if (favorites.includes(id)) {
        favorites = favorites.filter((fid) => fid !== id);
        alert(translations[currentLang].removedFromFav);
      } else {
        favorites.push(id);
        alert(translations[currentLang].addedToFav);
      }
      localStorage.setItem("favorites", JSON.stringify(favorites));
      updateCounts();
    }
    window.toggleFavorite = toggleFavorite;

    function toggleCompare(id) {
      if (compareList.includes(id)) {
        compareList = compareList.filter((cid) => cid !== id);
        alert(translations[currentLang].removedFromCompare);
      } else {
        compareList.push(id);
        alert(translations[currentLang].addedToCompare);
      }
      localStorage.setItem("compareList", JSON.stringify(compareList));
      updateCounts();
    }
    window.toggleCompare = toggleCompare;

    // -------------------- COMPARISON MODAL --------------------
    const compareModal = document.getElementById("compare-modal");
    const compareClose = compareModal.querySelector(".compare-close");
    const compareBody = document.getElementById("compare-body");
    const btnViewCompare = document.getElementById("btn-view-compare");

    btnViewCompare.addEventListener("click", () => {
      // Build a table of all compare properties
      let html = "<h2>Comparison</h2><table border='1' style='width:100%;border-collapse:collapse'>";
      html += "<tr><th>Title</th><th>Price</th><th>Type</th><th>Bedrooms</th><th>Bathrooms</th></tr>";
      compareList.forEach((cid) => {
        const prop = allProperties.find((p) => p.id === cid);
        if (prop) {
          html += `<tr>
            <td>${prop.title}</td>
            <td>${prop.price}</td>
            <td>${prop.type}</td>
            <td>${prop.bedrooms}</td>
            <td>${prop.bathrooms}</td>
          </tr>`;
        }
      });
      html += "</table>";
      compareBody.innerHTML = html;

      compareModal.style.display = "block";
    });

    compareClose.addEventListener("click", () => {
      compareModal.style.display = "none";
    });
    window.addEventListener("click", (e) => {
      if (e.target === compareModal) {
        compareModal.style.display = "none";
      }
    });

    // -------------------- GEOLOCATION --------------------
    const btnLocate = document.getElementById("btn-locate");
    btnLocate.addEventListener("click", () => {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            map.setView([latitude, longitude], 14);
          },
          (err) => {
            console.error(err);
            alert("Unable to retrieve your location.");
          }
        );
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    });

    // -------------------- EXPLORE HOTSPOTS --------------------
    const btnExplore = document.getElementById("btn-explore");
    btnExplore.addEventListener("click", () => {
      // Example hotspots (Cairo, Alexandria, Hurghada, etc.)
      const hotspots = [
        { lat: 30.0444, lng: 31.2357, zoom: 10 }, // Cairo
        { lat: 31.2001, lng: 29.9187, zoom: 11 }, // Alexandria
        { lat: 27.2579, lng: 33.8116, zoom: 11 }  // Hurghada
      ];
      let i = 0;
      const interval = setInterval(() => {
        const spot = hotspots[i];
        map.flyTo([spot.lat, spot.lng], spot.zoom, { duration: 2 });
        i++;
        if (i >= hotspots.length) {
          clearInterval(interval);
        }
      }, 3000);
    });

    // -------------------- MOBILE FILTER TOGGLE --------------------
    const mobileFilterToggle = document.getElementById("mobile-filter-toggle");
    const filterPanel = document.getElementById("filter-panel");
    let isFilterOpen = false;

    mobileFilterToggle.addEventListener("click", () => {
      isFilterOpen = !isFilterOpen;
      if (isFilterOpen) {
        filterPanel.classList.remove("collapsed");
        mobileFilterToggle.textContent = translations[currentLang].filterToggle === "Show Filters"
          ? "Hide Filters"
          : "ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÅŸÑÿßÿ™ÿ±";
      } else {
        filterPanel.classList.add("collapsed");
        mobileFilterToggle.textContent = translations[currentLang].filterToggle;
      }
    });

    // By default on small screens, start collapsed
    if (window.innerWidth < 768) {
      filterPanel.classList.add("collapsed");
    }
  </script>
</body>
</html>
